# Generated by generate_llm_code.py
# LLM: claude
# Mode: assisted

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor, RandomForestClassifier
from sklearn.metrics import (
    r2_score, mean_squared_error, classification_report, accuracy_score
)

RANDOM_SEED = 42

def load_and_preprocess(filepath):
    try:
        df = pd.read_csv(filepath)
        if df.shape[1] < 5:
            raise ValueError("Too few columns")
    except (ValueError, pd.errors.ParserError):
        df = pd.read_csv(filepath, sep=';', decimal=',')

    df.columns = df.columns.str.strip()

    unnamed_cols = [c for c in df.columns if c.startswith('Unnamed') or c == '']
    if unnamed_cols:
        df.drop(columns=unnamed_cols, inplace=True)

    if 'Date' in df.columns:
        df.drop(columns=['Date'], inplace=True)
    if 'Time' in df.columns:
        df.drop(columns=['Time'], inplace=True)

    for col in df.columns:
        df[col] = pd.to_numeric(df[col], errors='coerce')

    df.replace(-200, np.nan, inplace=True)
    df.replace(-200.0, np.nan, inplace=True)

    df.dropna(inplace=True)
    df.reset_index(drop=True, inplace=True)

    return df


def train_models(data, features):
    reg_target = 'PT08.S1(CO)'
    available_features = [f for f in features if f in data.columns]

    if reg_target not in data.columns:
        raise ValueError(f"Regression target '{reg_target}' not found in data.")

    median_c6h6 = data['C6H6(GT)'].median()
    data = data.copy()
    data['Risk_Label'] = (data['C6H6(GT)'] > median_c6h6).astype(int)

    X = data[available_features].values
    y_reg = data[reg_target].values
    y_clf = data['Risk_Label'].values

    X_train, X_test, y_reg_train, y_reg_test, y_clf_train, y_clf_test = train_test_split(
        X, y_reg, y_clf, test_size=0.2, random_state=RANDOM_SEED
    )

    reg_model = RandomForestRegressor(
        n_estimators=100, random_state=RANDOM_SEED, n_jobs=-1
    )
    reg_model.fit(X_train, y_reg_train)
    y_pred_reg = reg_model.predict(X_test)

    reg_results = {
        'R2': r2_score(y_reg_test, y_pred_reg),
        'RMSE': np.sqrt(mean_squared_error(y_reg_test, y_pred_reg))
    }

    clf_model = RandomForestClassifier(
        n_estimators=100, random_state=RANDOM_SEED, n_jobs=-1
    )
    clf_model.fit(X_train, y_clf_train)
    y_clf_pred = clf_model.predict(X_test)

    clf_results = classification_report(y_clf_test, y_clf_pred, output_dict=True)
    accuracy = accuracy_score(y_clf_test, y_clf_pred)

    return reg_results, clf_results, accuracy


def main():
    data = load_and_preprocess('data/AirQualityUCI.csv')
    features = ['CO(GT)', 'NOx(GT)', 'NO2(GT)', 'C6H6(GT)', 'T', 'RH']

    reg_results, clf_results, accuracy = train_models(data, features)

    print(f"ACCURACY={accuracy:.6f}")
    
main()