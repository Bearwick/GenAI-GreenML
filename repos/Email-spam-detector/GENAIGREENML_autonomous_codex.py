# Generated by generate_llm_code.py
# LLM: codex
# Mode: autonomous

import os
import glob
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.pipeline import Pipeline
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.naive_bayes import MultinomialNB
from sklearn.metrics import accuracy_score

def _find_csv_file():
    files = glob.glob("*.csv")
    if not files:
        files = glob.glob("**/*.csv", recursive=True)
    if not files:
        raise FileNotFoundError("No CSV file found in the working directory.")
    return sorted(files)[0]

file_path = _find_csv_file()
df = pd.read_csv(file_path)

df.columns = [c.strip() for c in df.columns]
text_columns = [c for c in ["subject", "body", "text", "urls", "sender", "filename"] if c in df.columns]
df[text_columns] = df[text_columns].fillna("")
df["combined_text"] = df[text_columns].agg(" ".join, axis=1)

if "label" in df.columns:
    y = df["label"]
else:
    y = df.iloc[:, -1]

if y.dtype == object or y.dtype.name == "category":
    le = LabelEncoder()
    y = le.fit_transform(y)
else:
    y = y.values

X = df["combined_text"]

unique_labels = np.unique(y)
stratify = y if len(unique_labels) > 1 else None

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=stratify
)

pipeline = Pipeline([
    ("vectorizer", CountVectorizer(stop_words="english", max_features=5000)),
    ("model", MultinomialNB())
])

pipeline.fit(X_train, y_train)
y_pred = pipeline.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)

print(f"ACCURACY={accuracy:.6f}")

# OPTIMIZATION SUMMARY
# - Used a sparse CountVectorizer with a capped vocabulary to minimize memory and computation.
# - Selected MultinomialNB for fast, CPU-efficient training and inference on text data.
# - Combined relevant text fields into a single feature to simplify preprocessing and reduce overhead.
# - Employed a deterministic train/test split for reproducibility without extra computation.