# Generated by generate_llm_code.py
# LLM: claude
# Mode: assisted

import pandas as pd
import numpy as np
from sklearn.decomposition import PCA
from sklearn.metrics import accuracy_score
from sklearn.preprocessing import LabelEncoder, StandardScaler
from xgboost import XGBClassifier

RANDOM_SEED = 42

def load_csv_robust(path):
    df = pd.read_csv(path, header=None, low_memory=False)
    if df.shape[1] < 5:
        df = pd.read_csv(path, header=None, sep=';', decimal=',', low_memory=False)
    return df

def preprocess_data(df, fit=True, scaler=None, label_encoders=None, train_columns=None):
    df = df.copy()
    last_col = df.columns[-1]
    if df[last_col].dtype == object:
        df[last_col] = df[last_col].str.strip()

    second_last_col = df.columns[-2]
    if df[second_last_col].dtype == object:
        df[second_last_col] = df[second_last_col].str.strip()

    label_col = second_last_col
    y_raw = df[label_col].copy()
    df = df.drop(columns=[last_col])

    cat_cols = df.select_dtypes(include=['object']).columns.tolist()
    if label_col in cat_cols:
        cat_cols.remove(label_col)

    if fit:
        label_encoders = {}
        for c in cat_cols:
            le = LabelEncoder()
            df[c] = le.fit_transform(df[c].astype(str))
            label_encoders[c] = le
    else:
        for c in cat_cols:
            le = label_encoders[c]
            df[c] = df[c].astype(str).map(lambda x, _le=le: _le.transform([x])[0] if x in _le.classes_ else -1)

    X = df.drop(columns=[label_col])

    if fit:
        train_columns = X.columns.tolist()
    else:
        for c in train_columns:
            if c not in X.columns:
                X[c] = 0
        X = X[train_columns]

    X = X.values.astype(np.float32)

    if fit:
        scaler = StandardScaler()
        X = scaler.fit_transform(X)
    else:
        X = scaler.transform(X)

    y_binary = (y_raw != 'normal').astype(np.int8).values

    if fit:
        return X, y_binary, scaler, label_encoders, train_columns
    else:
        return X, y_binary

train_df = load_csv_robust("data/raw/Train.txt")
test_df = load_csv_robust("data/raw/Test.txt")

X_train_scaled, y_train, scaler, label_encoders, train_columns = preprocess_data(train_df, fit=True)
X_test_scaled, y_test = preprocess_data(test_df, fit=False, scaler=scaler, label_encoders=label_encoders, train_columns=train_columns)

pca = PCA(n_components=0.95, random_state=RANDOM_SEED)
X_train_pca = pca.fit_transform(X_train_scaled)
X_test_pca = pca.transform(X_test_scaled)

model = XGBClassifier(
    n_estimators=200,
    max_depth=6,
    learning_rate=0.1,
    subsample=0.8,
    colsample_bytree=0.8,
    eval_metric="logloss",
    random_state=RANDOM_SEED,
    tree_method="hist",
    n_jobs=-1,
    verbosity=0
)
model.fit(X_train_pca, y_train)

y_pred =