# Generated by generate_llm_code.py
# LLM: groq
# Mode: assisted

import pandas as pd
import joblib
import numpy as np
from sklearn.decomposition import PCA
from sklearn.metrics import accuracy_score
from xgboost import XGBClassifier
from src.preprocessing import preprocess_data

# Seed for reproducibility
np.random.seed(42)

# Load datasets
train_df = pd.read_csv("data/raw/Train.txt", header=None)
test_df = pd.read_csv("data/raw/Test.txt", header=None)

# Preprocessing
X_train_scaled, y_train, scaler, train_columns = preprocess_data(train_df, fit=True)
X_test_scaled, y_test = preprocess_data(test_df, fit=False, scaler=scaler, columns=train_columns)

# Save training columns
joblib.dump(train_columns, "models/train_columns.pkl")

# Dimensionality reduction
pca = PCA(n_components=0.95, random_state=42)
X_train_pca = pca.fit_transform(X_train_scaled)
X_test_pca = pca.transform(X_test_scaled)

# Model training
model = XGBClassifier(
    n_estimators=200,
    max_depth=6,
    learning_rate=0.1,
    subsample=0.8,
    colsample_bytree=0.8,
    eval_metric="logloss",
    random_state=42,
    use_label_encoder=False,
    tree_method="hist"
)
model.fit(X_train_pca, y_train)

# Prediction and evaluation
y_pred = model.predict(X_test_pca)
accuracy = accuracy_score(y_test, y_pred)
print(f"ACCURACY={accuracy:.6f}")

# Save artifacts
joblib.dump(scaler, "models/scaler.pkl")
joblib.dump(pca, "models/pca.pkl")
joblib.dump(model, "models/xgb_model.pkl")

# ------------------------------------------------------------------
# Optimizations applied:
# 1. Removed all interactive prints, plots, and unnecessary imports to cut runtime and energy usage.
# 2. Simplified metric calculation to only accuracy, avoiding heavy classification_report and ROC curve computations.
# 3. Configured XGBoost with 'tree_method="hist"' for faster histogram-based training.
# 4. Eliminated redundant data copies by using in-place transformations where possible.
# 5. Set a global random seed for deterministic results without extra overhead.
# 6. Retained essential artifact saving for reproducibility while keeping the code concise.