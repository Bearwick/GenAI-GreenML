# Generated by generate_llm_code.py
# LLM: chatgpt
# Mode: assisted

import numpy as np
import pandas as pd


RANDOM_SEED = 0
np.random.seed(RANDOM_SEED)

DATASET_HEADERS = ["sepal_length", "sepal_width", "petal_length", "petal_width", "species"]
FILE_NAME = "iris.csv"


def _read_csv_with_fallback(path: str, expected_headers):
    df = pd.read_csv(path)
    if list(df.columns) != list(expected_headers) or df.shape[1] != len(expected_headers):
        df_alt = pd.read_csv(path, sep=";", decimal=",")
        if df_alt.shape[1] == len(expected_headers):
            df = df_alt
    return df


def _ensure_schema(df: pd.DataFrame, expected_headers):
    if df.shape[1] == len(expected_headers):
        if list(df.columns) != list(expected_headers):
            df = df.copy()
            df.columns = expected_headers
    else:
        cols = list(df.columns)
        existing = [h for h in expected_headers if h in cols]
        if len(existing) == len(expected_headers):
            df = df[expected_headers].copy()
        else:
            df = df.iloc[:, : len(expected_headers)].copy()
            df.columns = expected_headers
    return df


def _encode_labels(species: pd.Series) -> np.ndarray:
    mapping = {"setosa": 0, "versicolor": 1, "virginica": 2}
    encoded = species.map(mapping)
    return encoded.astype(np.int64).to_numpy()


def _nearest_centroid_accuracy(X: np.ndarray, y: np.ndarray, n_classes: int = 3) -> float:
    centroids = np.empty((n_classes, X.shape[1]), dtype=np.float64)
    for k in range(n_classes):
        centroids[k] = X[y == k].mean(axis=0)

    x2 = np.sum(X * X, axis=1, keepdims=True)
    c2 = np.sum(centroids * centroids, axis=1, keepdims=True).T
    d2 = x2 + c2 - 2.0 * (X @ centroids.T)
    np.maximum(d2, 0.0, out=d2)

    y_pred = np.argmin(d2, axis=1)
    return float(np.mean(y_pred == y))


def main():
    df = _read_csv_with_fallback(FILE_NAME, DATASET_HEADERS)
    df = _ensure_schema(df, DATASET_HEADERS)

    X = df[["petal_length", "petal_width"]].to_numpy(dtype=np.float64, copy=False)
    y = _encode_labels(df["species"])

    accuracy = _nearest_centroid_accuracy(X, y, n_classes=3)
    print(f"ACCURACY={accuracy:.6f}")


if __name__ == "__main__":
    main()

# Optimization Summary
# - Removed all plotting and file-saving side effects to eliminate heavy rendering overhead and disk I/O.
# - Replaced np.loadtxt(dtype=object) with pandas parsing to avoid object arrays and reduce conversion overhead.
# - Implemented robust CSV parsing fallback (default, then sep=';' and decimal=',') to prevent mis-parses without manual edits.
# - Ensured schema via DATASET_HEADERS/df.columns logic to avoid hard assumptions about column order/names.
# - Encoded labels with a vectorized pandas map instead of multiple boolean assignments to reduce passes over the data.
# - Computed nearest-centroid distances using a squared Euclidean matrix formula (no sqrt) to cut computation while preserving argmin/accuracy.
# - Used to_numpy(copy=False) and float64 once to minimize redundant data movement and conversions.
# - Set a fixed random seed for reproducibility (even though this pipeline is deterministic).