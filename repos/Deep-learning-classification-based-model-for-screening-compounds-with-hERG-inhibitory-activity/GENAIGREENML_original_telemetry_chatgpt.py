# Generated by generate_llm_code.py
# LLM: chatgpt
# Mode: original_telemetry

import pandas as pd
from keras.layers import BatchNormalization, Dense
from keras.models import Sequential
from numpy.random import seed
from sklearn.ensemble import IsolationForest
import numpy as np
from sklearn.preprocessing import MinMaxScaler
from sklearn.decomposition import PCA
from sklearn.metrics import confusion_matrix
from sklearn import metrics
from sklearn.metrics import precision_score, recall_score, roc_auc_score
from sklearn.metrics import f1_score
import tensorflow as tf

tf.random.set_seed(1)
np.random.seed(100)
seed(0)


def main():
    training_data_df = pd.read_csv("herg_train_activity.csv")
    X = training_data_df.drop("Activity_value", axis=1).values
    Y = training_data_df[["Activity_value"]].values

    test_data_df = pd.read_csv("herg_test_activity.csv")
    X_test = test_data_df.drop("Activity_value", axis=1).values
    Y_test = test_data_df[["Activity_value"]].values

    scaler = MinMaxScaler(feature_range=(0, 1)).fit(X)
    scaler1 = MinMaxScaler(feature_range=(0, 1)).fit(X_test)
    X = scaler.transform(X)
    X_test = scaler.transform(X_test)

    pca = PCA(n_components=2)
    iso = IsolationForest(
        contamination=0.1,
        n_estimators=100,
        random_state=0,
        verbose=0,
    )
    pca1 = pca.fit_transform(X)
    yhat = iso.fit_predict(pca1)
    pca2 = pca.fit_transform(X_test)
    yhat_1 = iso.fit_predict(pca2)

    mask = yhat != -1
    X, Y = X[mask, :], Y[mask]

    mask = yhat_1 != -1
    X_test, Y_test = X_test[mask, :], Y_test[mask]

    model = Sequential()
    model.add(BatchNormalization())
    model.add(
        Dense(
            200,
            input_dim=8,
            activation="relu",
            kernel_initializer="random_uniform",
            kernel_regularizer=None,
            kernel_constraint="MaxNorm",
        )
    )
    model.add(BatchNormalization())
    model.add(Dense(200, activation="relu"))
    model.add(Dense(200, activation="relu"))
    model.add(Dense(1, activation="sigmoid"))
    model.compile(loss="binary_crossentropy", optimizer="adam", metrics=["accuracy"])

    _history = model.fit(
        X,
        Y,
        epochs=200,
        batch_size=100,
        shuffle=True,
        verbose=0,
        validation_data=(X_test, Y_test),
    )

    _train_loss, train_acc = model.evaluate(X, Y, verbose=0)
    _test_loss, test_acc = model.evaluate(X_test, Y_test, verbose=0)

    Xnew = pd.read_csv("cas.csv").values
    Xnew = scaler.transform(Xnew)

    y_pred = model.predict(X, verbose=0)
    y_pred_class = model.predict(X, verbose=0)

    y_pred_1 = model.predict(X_test, verbose=0)
    y_pred_class_1 = model.predict(X_test, verbose=0)

    prediction = model.predict(Xnew, verbose=0)

    cutoff = 0.5

    y_prediction_1 = np.where(y_pred > cutoff, 1, 0)
    y_prediction_2 = np.where(y_pred_class > cutoff, 1, 0)

    y_prediction_3 = np.where(y_pred_1 > cutoff, 1, 0)
    y_prediction_4 = np.where(y_pred_class_1 > cutoff, 1, 0)

    y_prediction = np.where(prediction > cutoff, 1, 0)

    _ = metrics.classification_report(Y, y_prediction_1, digits=2)

    y_prediction_1 = y_prediction_1[:, 0]
    y_prediction_2 = y_prediction_2[:, 0]

    _auc_train = roc_auc_score(Y, y_prediction_1)
    _acc_train = metrics.accuracy_score(Y, y_prediction_2)
    _precision_train = precision_score(Y, y_prediction_2)
    _recall_train = recall_score(Y, y_prediction_2)
    _f1_train = f1_score(Y, y_prediction_2)
    _matrix_train = confusion_matrix(Y, y_prediction_2)

    y_prediction_3 = y_prediction_3[:, 0]
    y_prediction_4 = y_prediction_4[:, 0]

    _auc_test = roc_auc_score(Y_test, y_prediction_4)
    _acc_test = metrics.accuracy_score(Y_test, y_prediction_4)
    _precision_test = precision_score(Y_test, y_prediction_4)
    recall1 = recall_score(Y_test, y_prediction_4)
    _ = recall1
    _f1_test = f1_score(Y_test, y_prediction_4)
    _matrix_test = confusion_matrix(Y_test, y_prediction_4)

    pd.DataFrame(y_prediction, columns=["prediction"]).to_csv("CAS_full_herg.csv")

    accuracy = test_acc
    print(f"ACCURACY={accuracy:.6f}")


if __name__ == "__main__":
    main()