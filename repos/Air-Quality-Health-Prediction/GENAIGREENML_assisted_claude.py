# Generated by generate_llm_code.py
# LLM: claude
# Mode: assisted

import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor, RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import (
    r2_score,
    mean_squared_error,
    classification_report,
    accuracy_score,
)

RANDOM_SEED = 42

def load_and_preprocess(filepath):
    try:
        df = pd.read_csv(filepath)
        if df.shape[1] < 5:
            raise ValueError("Too few columns")
    except (ValueError, pd.errors.ParserError):
        df = pd.read_csv(filepath, sep=';', decimal=',')

    unnamed_cols = [c for c in df.columns if 'Unnamed' in str(c)]
    df.drop(columns=unnamed_cols, inplace=True, errors='ignore')

    if df.columns[0] == 'Date' and df.columns[1] == 'Time':
        df['Datetime'] = pd.to_datetime(
            df['Date'] + ' ' + df['Time'],
            format='%d/%m/%Y %H.%M.%S',
            errors='coerce',
        )
        df.drop(columns=['Date', 'Time'], inplace=True)
        df.set_index('Datetime', inplace=True)

    for col in df.columns:
        if df[col].dtype == object:
            df[col] = df[col].astype(str).str.replace(',', '.', regex=False)
            df[col] = pd.to_numeric(df[col], errors='coerce')

    df.replace(-200, np.nan, inplace=True)
    df.dropna(how='all', inplace=True)

    df = df.resample('D').mean()
    df.dropna(inplace=True)

    features = ['CO(GT)', 'NOx(GT)', 'NO2(GT)', 'C6H6(GT)', 'T', 'RH']
    available = [f for f in features if f in df.columns]

    np.random.seed(RANDOM_SEED)
    df['Hospital_Visits'] = (
        df[available].sum(axis=1) * 0.05 + np.random.normal(0, 1, len(df))
    ).clip(lower=0)

    median_visits = df['Hospital_Visits'].median()
    df['Risk_Label'] = (df['Hospital_Visits'] > median_visits).astype(int)

    return df


def main():
    data = load_and_preprocess('data/AirQualityUCI.csv')
    features = ['CO(GT)', 'NOx(GT)', 'NO2(GT)', 'C6H6(GT)', 'T', 'RH']
    features = [f for f in features if f in data.columns]

    X = data[features].values
    y_reg = data['Hospital_Visits'].values
    y_clf = data['Risk_Label'].values

    X_train, X_test, y_reg_train, y_reg_test, y_clf_train, y_clf_test = train_test_split(
        X, y_reg, y_clf, test_size=0.2, random_state=RANDOM_SEED
    )

    reg_model = RandomForestRegressor(n_estimators=100, random_state=RANDOM_SEED, n_jobs=-1)
    reg_model.fit(X_train, y_reg_train)
    y_pred_reg = reg_model.predict(X_test)

    clf_model = RandomForestClassifier(n_estimators=100, random_state=RANDOM_SEED, n_jobs=-1)
    clf_model.fit(X_train, y_clf_train)
    y_clf_pred = clf_model.predict(X_test)

    accuracy = accuracy_score(y_clf_test, y_clf_pred)
    print(f"ACCURACY={accuracy:.6f}")