# Generated by generate_llm_code.py
# LLM: chatgpt
# Mode: original_telemetry

from pyspark import SparkContext, SparkConf
from pyspark.shell import spark
from pyspark.sql import SQLContext, SparkSession
import numpy as np
from pyspark.sql import DataFrame
from pyspark.sql.functions import when
from pyspark.ml.feature import Imputer
from pyspark.ml.feature import StandardScaler
from pyspark.ml.feature import ChiSqSelector
from pyspark.ml.classification import LogisticRegression
from pyspark.ml.evaluation import BinaryClassificationEvaluator
from pyspark.ml.classification import RandomForestClassifier
from pyspark.ml.evaluation import MulticlassClassificationEvaluator
from pyspark.ml.regression import LinearRegression
from pyspark.ml.regression import GeneralizedLinearRegression
import matplotlib.pyplot as plt
import pandas as pd
from pyspark.sql.types import StructType, StructField, NumericType
from pyspark.ml.feature import StandardScaler
from pyspark.ml.feature import VectorAssembler
import time


def diabetes():
    sc = SparkSession.builder.getOrCreate()

    raw_data = (
        spark.read.format("csv")
        .option("header", "true")
        .option("inferSchema", "true")
        .load("diabetes.csv")
    )

    raw_data = raw_data.withColumn(
        "Glucose", when(raw_data.Glucose == 0, np.nan).otherwise(raw_data.Glucose)
    )
    raw_data = raw_data.withColumn(
        "BloodPressure",
        when(raw_data.BloodPressure == 0, np.nan).otherwise(raw_data.BloodPressure),
    )
    raw_data = raw_data.withColumn(
        "SkinThickness",
        when(raw_data.SkinThickness == 0, np.nan).otherwise(raw_data.SkinThickness),
    )
    raw_data = raw_data.withColumn(
        "BMI", when(raw_data.BMI == 0, np.nan).otherwise(raw_data.BMI)
    )
    raw_data = raw_data.withColumn(
        "Insulin", when(raw_data.Insulin == 0, np.nan).otherwise(raw_data.Insulin)
    )

    imputer = Imputer(
        inputCols=["Glucose", "BloodPressure", "SkinThickness", "BMI", "Insulin"],
        outputCols=["Glucose", "BloodPressure", "SkinThickness", "BMI", "Insulin"],
    )
    model = imputer.fit(raw_data)
    raw_data = model.transform(raw_data)

    cols = raw_data.columns
    cols.remove("Outcome")
    assembler = VectorAssembler(inputCols=cols, outputCol="features")
    raw_data = assembler.transform(raw_data)

    standardscaler = StandardScaler().setInputCol("features").setOutputCol(
        "Scaled_features"
    )
    raw_data = standardscaler.fit(raw_data).transform(raw_data)

    train, test = raw_data.randomSplit([0.8, 0.2], seed=12345)

    dataset_size = float(train.select("Outcome").count())
    numPositives = train.select("Outcome").where("Outcome == 1").count()
    numNegatives = float(dataset_size - numPositives)

    BalancingRatio = numNegatives / dataset_size
    train = train.withColumn(
        "classWeights",
        when(train.Outcome == 1, BalancingRatio).otherwise(1 - BalancingRatio),
    )

    css = ChiSqSelector(
        featuresCol="Scaled_features", outputCol="Aspect", labelCol="Outcome", fpr=0.05
    )
    train = css.fit(train).transform(train)
    test = css.fit(test).transform(test)

    lr = LogisticRegression(
        labelCol="Outcome",
        featuresCol="Aspect",
        weightCol="classWeights",
        maxIter=10,
    )
    model = lr.fit(train)
    predict_test = model.transform(test)

    evaluator = MulticlassClassificationEvaluator(
        labelCol="Outcome", predictionCol="prediction", metricName="accuracy"
    )
    accuracy = evaluator.evaluate(predict_test)
    print(f"ACCURACY={accuracy:.6f}")

    sc.stop()


def main():
    diabetes()


if __name__ == "__main__":
    main()