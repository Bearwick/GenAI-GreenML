# Generated by generate_llm_code.py
# LLM: chatgpt
# Mode: original_telemetry

from sklearn import svm
from sklearn.model_selection import train_test_split
from sklearn import metrics
import pickle
import numpy as np
import csv
import copy
import unittest

from sklearn.preprocessing import StandardScaler
from sklearn.neural_network import MLPClassifier

mlp = MLPClassifier(hidden_layer_sizes=(30, 30, 30, 30), max_iter=1000)
features = []
labels = []
pFeatures = []


def makeCSV(inpt):
    try:
        first = True
        with open(inpt, newline="") as csvfile:
            reader = csv.reader(csvfile, delimiter=" ", quotechar="|")
            for row in reader:
                cols = row[0].split(",")
                if cols[len(cols) - 1] == "":
                    cols.pop()
                if first is False:
                    both = np.asarray(cols, dtype=np.double).tolist()
                    num = both.pop()
                    if num > 0:
                        num = 1
                    elif num < 0:
                        num = -1
                    labels.append(num)
                    features.append(both)
                else:
                    first = False
    except:
        pass


def trainAndTestModel():
    makeCSV("14k.csv")
    feat_train, feat_test, lab_train, lab_test = train_test_split(
        features, labels, test_size=0.3
    )
    scaler = StandardScaler()
    scaler.fit(feat_train)
    feat_train = scaler.transform(feat_train)
    feat_test = scaler.transform(feat_test)
    mlp.fit(feat_train, lab_train)
    y_pred = mlp.predict(feat_test)
    accuracy = metrics.accuracy_score(lab_test, y_pred)
    print(f"ACCURACY={accuracy:.6f}")


def loadModel():
    global mlp
    pickle_in = open("dict.pickle", "rb")
    mlp = pickle.load(pickle_in)


def saveModel():
    global mlp
    pickle_out = open("dict.pickle", "wb")
    pickle.dump(mlp, pickle_out)
    pickle_out.close()


def wipeVariables():
    global features
    global labels
    features = []
    labels = []


def predict():
    loadModel()
    takeInput()
    scaler = StandardScaler()
    scaler.fit(pFeatures)
    f_prediction = scaler.transform(pFeatures)
    prediction = mlp.predict(f_prediction)
    saveModel()


def takeInput():
    try:
        first = True
        with open("input.csv", newline="") as csvfile:
            reader = csv.reader(csvfile, delimiter=" ", quotechar="|")
            for row in reader:
                cols = row[0].split(",")
                if cols[len(cols) - 1] == "":
                    cols.pop()
                if first is False:
                    ftrs = np.asarray(cols, dtype=np.double).tolist()
                    pFeatures.append(ftrs)
                else:
                    first = False
    except:
        pass


predict()


class Testing(unittest.TestCase):
    def setUp(self):
        wipeVariables()
        return super().setUp()

    def tearDown(self):
        wipeVariables()
        return super().tearDown()

    def test_MakeCSV4(self):
        makeCSV("test.csv")
        self.assertEqual(len(features), 4)

    def test_MakeCSV2(self):
        makeCSV("test2.csv")
        self.assertEqual(len(labels), 2)