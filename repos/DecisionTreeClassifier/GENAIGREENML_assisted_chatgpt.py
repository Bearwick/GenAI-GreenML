# Generated by generate_llm_code.py
# LLM: chatgpt
# Mode: assisted

import os
import random

import numpy as np
import pandas as pd
from sklearn.metrics import accuracy_score
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier


SEED = 42


def set_reproducible_seed(seed: int) -> None:
    random.seed(seed)
    np.random.seed(seed)


def read_csv_robust(path: str, expected_headers) -> pd.DataFrame:
    df = pd.read_csv(path)
    cols = [c.strip() for c in df.columns]
    df.columns = cols

    expected = [h.strip() for h in expected_headers]
    if len(cols) != len(expected) or any(c not in expected for c in cols):
        df = pd.read_csv(path, sep=";", decimal=",")
        df.columns = [c.strip() for c in df.columns]
    return df


def prepare_features_and_target(df: pd.DataFrame, target_name: str):
    cols = [c.strip() for c in df.columns]
    df.columns = cols

    target_lower = target_name.strip().lower()
    target_col = next((c for c in cols if c.lower() == target_lower), None)
    if target_col is None:
        raise ValueError(f"Target column '{target_name}' not found in dataset columns: {cols}")

    feature_cols = [c for c in cols if c != target_col]
    if not feature_cols:
        raise ValueError("No feature columns found after separating target.")

    X = df[feature_cols]
    y = df[target_col]
    return X, y


def main() -> None:
    set_reproducible_seed(SEED)

    dataset_path = "music.csv"
    if not os.path.exists(dataset_path):
        raise FileNotFoundError(f"Dataset not found at path: {dataset_path}")

    df = read_csv_robust(dataset_path, expected_headers=["age", "gender", "genre"])
    X, y = prepare_features_and_target(df, target_name="genre")

    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=0.2, random_state=SEED, shuffle=True
    )

    model = DecisionTreeClassifier(random_state=SEED)
    model.fit(X_train, y_train)

    predictions = model.predict(X_test)
    accuracy = accuracy_score(y_test, predictions)
    print(f"ACCURACY={accuracy:.6f}")


if __name__ == "__main__":
    main()

# Optimization Summary
# - Ensured reproducibility with fixed seeds and model/train_test_split random_state to avoid reruns and stabilize outputs.
# - Implemented robust CSV parsing with a fallback delimiter/decimal format to prevent repeated manual retries and wasted compute.
# - Avoided unnecessary dataframe copies by selecting feature columns directly rather than creating intermediate modified structures.
# - Encapsulated steps into small functions to keep execution minimal and readable while preventing redundant preprocessing.