#!/usr/bin/env bash
set -euo pipefail

REPOS_DIR="repos"
BASE_NAME="GENAIGREENML"
GEMINI_API_SCRIPT="scripts/APIs/gemini_api.py"

# Default LLMs used when none are provided as args.
ALL_LLMS=("gemini" "chatGPT" "claude")

if [[ ! -d "$REPOS_DIR" ]]; then
  echo "Repos directory not found: $REPOS_DIR" >&2
  exit 1
fi

LLMS=("$@")
if [[ ${#LLMS[@]} -eq 0 ]]; then
  LLMS=("${ALL_LLMS[@]}")
fi

generate_file() {
  local src_file="$1"
  local out_file="$2"
  local llm_name="$3"
  local mode="$4"

  local generated_code=""
  if [[ "$llm_name" == "gemini" && -f "$GEMINI_API_SCRIPT" ]]; then
    dataset_headers=""
    csv_file="$(find "$project" -type f -name "*.csv" \
      -not -path "$project/venv/*" \
      -not -path "$project/.venv/*" \
      -not -path "$project/.git/*" \
      -not -path "$project/.*/**" \
      -print -quit)"
    if [[ -n "$csv_file" ]]; then
      dataset_headers="$(head -n 1 "$csv_file" | tr -d '\r')"
    fi
    generated_code="$(python3 "$GEMINI_API_SCRIPT" --mode "$mode" --headers "$dataset_headers" < "$src_file" 2>/dev/null || true)"
  fi

  {
    echo "# Generated by $0"
    echo "# LLM: $llm_name"
    echo "# Mode: $mode"
    echo ""
    if [[ -n "$generated_code" ]]; then
      echo "$generated_code"
    else
      cat "$src_file"
    fi
  } > "$out_file"
}

for project in "$REPOS_DIR"/*; do
  [[ ! -d "$project" ]] && continue

  project_name=$(basename "$project")
  echo "[*] Project: $project_name"

  src_file=""
  if [[ -f "$project/original.py" ]]; then
    src_file="$project/original.py"
  else
    py_files=()
    while IFS= read -r -d '' py_file; do
      py_files+=("$py_file")
    done < <(find "$project" -type f -name "*.py" \
      -not -name "${BASE_NAME}*.py" \
      -not -path "$project/venv/*" \
      -not -path "$project/.venv/*" \
      -not -path "$project/.git/*" -print0)

    if [[ ${#py_files[@]} -eq 1 ]]; then
      src_file="${py_files[0]}"
    else
      echo "[i] Skipping $project_name (no single python file or original.py)"
      continue
    fi
  fi

  # original_telemetry.py must be created using a single LLM.
  primary_llm="${LLMS[0]}"
  generate_file \
    "$src_file" \
    "$project/${BASE_NAME}_original_telemetry.py" \
    "$primary_llm" \
    "original_telemetry"

  # assisted/autonomous are generated per-LLM.
  for llm in "${LLMS[@]}"; do
    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_assisted_${llm}.py" \
      "$llm" \
      "assisted"

    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_autonomous_${llm}.py" \
      "$llm" \
      "autonomous"
  done

  # Update requirements.txt using project's venv pipreqs if available.
  if [[ -x "$project/venv/bin/pipreqs" ]]; then
    "$project/venv/bin/pipreqs" "$project" \
      --force --encoding utf-8 --ignore "$project/venv" >/dev/null 2>&1 || \
      echo "[!] pipreqs failed for $project_name"
  else
    echo "[!] venv pipreqs not found; skipping requirements update for $project_name"
  fi
done

echo "[+] Done"
