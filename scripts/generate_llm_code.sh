#!/usr/bin/env bash
set -euo pipefail

REPOS_DIR="repos"
BASE_NAME="GENAIGREENML"
GEMINI_API_SCRIPT="scripts/APIs/gemini_api.py"
GEMINI_REQUESTS=0
GEMINI_PYTHON="scripts/venv/bin/python"

# Default LLMs used when none are provided as args.
ALL_LLMS=("gemini") # "chatGPT" "claude"

if [[ ! -d "$REPOS_DIR" ]]; then
  echo "Repos directory not found: $REPOS_DIR" >&2
  exit 1
fi

LLMS=("$@")
if [[ ${#LLMS[@]} -eq 0 ]]; then
  LLMS=("${ALL_LLMS[@]}")
fi

generate_file() {
  local src_file="$1"
  local out_file="$2"
  local llm_name="$3"
  local mode="$4"

  local generated_code=""
  if [[ "$llm_name" == "gemini" && -f "$GEMINI_API_SCRIPT" ]]; then
    GEMINI_REQUESTS=$((GEMINI_REQUESTS + 1))
    if (( GEMINI_REQUESTS % 10 == 0 )); then
      echo "[i] Gemini rate limit pause (60s) after $GEMINI_REQUESTS requests"
      sleep 60
    fi
    dataset_headers=""
    dataset_file=""
    # 1) Prefer a dataset named GENAIGREENMLDATASET.<ext>
    dataset_file="$(find "$project" -type f -name "GENAIGREENMLDATASET.*" \
      -not -path "$project/venv/*" \
      -not -path "$project/.venv/*" \
      -not -path "$project/.git/*" \
      -not -path "$project/.*/**" \
      -print -quit)"

    # 2) If no preferred dataset, try to find first dataset filename referenced in code.
    if [[ -z "$dataset_file" ]]; then
      dataset_ref="$(LC_ALL=C grep -Eo '[^\"'\"']+\\.(csv|tsv|txt|json|jsonl|xlsx|xls|parquet|feather|npy|npz|pkl|pickle|h5|hdf5|arff|sav|mat)' "$src_file" | head -n 1 || true)"
      if [[ -n "$dataset_ref" ]]; then
        dataset_file="$(find "$project" -type f -name "$dataset_ref" \
          -not -path "$project/venv/*" \
          -not -path "$project/.venv/*" \
          -not -path "$project/.git/*" \
          -not -path "$project/.*/**" \
          -print -quit)"
      fi
    fi

    # 3) Fallback to first dataset file found.
    if [[ -z "$dataset_file" ]]; then
      dataset_file="$(find "$project" -type f \\( \
          -name "*.csv" -o -name "*.tsv" -o -name "*.txt" -o -name "*.json" -o -name "*.jsonl" -o \
          -name "*.xlsx" -o -name "*.xls" -o -name "*.parquet" -o -name "*.feather" -o \
          -name "*.npy" -o -name "*.npz" -o -name "*.pkl" -o -name "*.pickle" -o \
          -name "*.h5" -o -name "*.hdf5" -o -name "*.arff" -o -name "*.sav" -o -name "*.mat" \\) \
        -not -name "requirements.txt" \
        -not -path "$project/venv/*" \
        -not -path "$project/.venv/*" \
        -not -path "$project/.git/*" \
        -not -path "$project/.*/**" \
        -print -quit)"
    fi

    if [[ -n "$dataset_file" ]]; then
      dataset_headers="$(head -n 1 "$dataset_file" | tr -d '\r')"
    fi
    if [[ -x "$GEMINI_PYTHON" ]]; then
      generated_code="$("$GEMINI_PYTHON" "$GEMINI_API_SCRIPT" --mode "$mode" --headers "$dataset_headers" < "$src_file" 2>/dev/null || true)"
    else
      echo "[!] Gemini venv python not found at $GEMINI_PYTHON"
      return
    fi
  fi

  if [[ -z "$generated_code" ]]; then
    echo "[i] Skipping $llm_name (not implemented or no response)"
    return
  fi

  {
    echo "# Generated by $0"
    echo "# LLM: $llm_name"
    echo "# Mode: $mode"
    echo ""
    echo "$generated_code"
  } > "$out_file"
}

for project in "$REPOS_DIR"/*; do
  [[ ! -d "$project" ]] && continue

  project_name=$(basename "$project")
  echo "[*] Project: $project_name"

  if find "$project" -type f -name "GENAIGREENMLDATASET.*" \
    -not -path "$project/venv/*" \
    -not -path "$project/.venv/*" \
    -not -path "$project/.git/*" \
    -not -path "$project/.*/**" \
    -print -quit | grep -q .; then
    echo "[i] Skipping $project_name (GENAIGREENMLDATASET present)"
    continue
  fi

  src_file=""
  if [[ -f "$project/original.py" ]]; then
    src_file="$project/original.py"
  else
    py_files=()
    while IFS= read -r -d '' py_file; do
      py_files+=("$py_file")
    done < <(find "$project" -type f -name "*.py" \
      -not -name "${BASE_NAME}*.py" \
      -not -path "$project/venv/*" \
      -not -path "$project/.venv/*" \
      -not -path "$project/.git/*" -print0)

    if [[ ${#py_files[@]} -eq 1 ]]; then
      src_file="${py_files[0]}"
    else
      echo "[i] Skipping $project_name (no single python file or original.py)"
      continue
    fi
  fi

  # original_telemetry.py must be created using a single LLM.
  primary_llm="${LLMS[0]}"
  generate_file \
    "$src_file" \
    "$project/${BASE_NAME}_original_telemetry.py" \
    "$primary_llm" \
    "original_telemetry"

  # assisted/autonomous are generated per-LLM.
  for llm in "${LLMS[@]}"; do
    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_assisted_${llm}.py" \
      "$llm" \
      "assisted"

    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_autonomous_${llm}.py" \
      "$llm" \
      "autonomous"
  done

  # Update requirements.txt using project's venv interpreter.
  if [[ -x "$project/venv/bin/python" ]]; then
    if ! "$project/venv/bin/python" -m pip show pipreqs >/dev/null 2>&1; then
      "$project/venv/bin/python" -m pip install -q pipreqs >/dev/null 2>&1 || \
        echo "[!] pipreqs install failed for $project_name"
    fi
    "$project/venv/bin/python" -m pipreqs "$project" \
      --force --encoding utf-8 --ignore "$project/venv" >/dev/null 2>&1 || \
      echo "[!] pipreqs failed for $project_name"
  else
    echo "[!] venv python not found; skipping requirements update for $project_name"
  fi
done

echo "[+] Done"
