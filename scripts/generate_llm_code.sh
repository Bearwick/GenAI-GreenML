#!/usr/bin/env bash
set -euo pipefail

REPOS_DIR="repos"
BASE_NAME="GENAIGREENML"

# Default LLMs used when none are provided as args.
ALL_LLMS=("chatGPT" "claude" "gemini")

if [[ ! -d "$REPOS_DIR" ]]; then
  echo "Repos directory not found: $REPOS_DIR" >&2
  exit 1
fi

LLMS=("$@")
if [[ ${#LLMS[@]} -eq 0 ]]; then
  LLMS=("${ALL_LLMS[@]}")
fi

generate_file() {
  local src_file="$1"
  local out_file="$2"
  local llm_name="$3"
  local mode="$4"

  {
    echo "# Generated by $0"
    echo "# LLM: $llm_name"
    echo "# Mode: $mode"
    echo ""
    cat "$src_file"
  } > "$out_file"
}

for project in "$REPOS_DIR"/*; do
  [[ ! -d "$project" ]] && continue

  project_name=$(basename "$project")
  echo "[*] Project: $project_name"

  src_file=""
  if [[ -f "$project/original.py" ]]; then
    src_file="$project/original.py"
  else
    py_files=()
    while IFS= read -r -d '' py_file; do
      py_files+=("$py_file")
    done < <(find "$project" -type f -name "*.py" \
      -not -name "${BASE_NAME}*.py" \
      -not -path "$project/venv/*" \
      -not -path "$project/.venv/*" \
      -not -path "$project/.git/*" -print0)

    if [[ ${#py_files[@]} -eq 1 ]]; then
      src_file="${py_files[0]}"
    else
      echo "[i] Skipping $project_name (no single python file or original.py)"
      continue
    fi
  fi

  # original_telemetry.py must be created using a single LLM.
  primary_llm="${LLMS[0]}"
  generate_file \
    "$src_file" \
    "$project/${BASE_NAME}_original_telemetry.py" \
    "$primary_llm" \
    "original_telemetry"

  # assisted/autonomous are generated per-LLM.
  for llm in "${LLMS[@]}"; do
    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_assisted_${llm}.py" \
      "$llm" \
      "assisted"

    generate_file \
      "$src_file" \
      "$project/${BASE_NAME}_autonomous_${llm}.py" \
      "$llm" \
      "autonomous"
  done
done

echo "[+] Done"
